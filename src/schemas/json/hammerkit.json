{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "JSON Schema for hammerkit's build file",
  "description": "Build tool with support for containerization",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "envs": {
      "$ref": "#/definitions/envMap"
    },
    "tasks": {
      "type": "object",
      "description": "A map of tasks",
      "additionalProperties": {
        "$ref": "#/definitions/task"
      }
    },
    "services": {
      "type": "object",
      "description": "A map of services",
      "additionalProperties": {
        "$ref": "#/definitions/service"
      }
    },
    "includes": {
      "$ref": "#/definitions/include"
    },
    "references": {
      "$ref": "#/definitions/reference"
    }
  },
  "definitions": {
    "labels": {
      "description": "A map of label values",
      "type": "object",
      "additionalProperties": {"type": "string"}
    },
    "envMap": {
      "description": "A map of environment values",
      "type": "object",
      "additionalProperties": {
        "type": "string"
      }
    },
    "taskCommand": {
      "anyOf": [
        {
          "description": "Command to be executed for the task",
          "type": "string"
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "cmd": {
              "description": "Command to be executed for the task",
              "type": "string"
            },
            "path": {
              "description": "Path below build file path",
              "type": "string"
            }
          },
          "required": ["cmd"]
        }
      ]
    },
    "include": {
      "type": "object",
      "description": "A map of includes",
      "additionalProperties": {
        "type": "string"
      }
    },
    "reference": {
      "type": "object",
      "description": "A map of references",
      "additionalProperties": {
        "type": "string"
      }
    },
    "taskSource": {
      "type": "array",
      "description": "A list of source files and folders",
      "items": {
        "type": "string"
      }
    },
    "taskGenerate": {
      "type": "array",
      "description": "A list of generated files and folders",
      "items": {
        "type": "string"
      }
    },
    "taskDependency": {
      "type": "array",
      "description": "A list of task dependencies that get executed before the current task",
      "items": {
        "type": "string"
      }
    },
    "taskNeed": {
      "type": "array",
      "description": "A list of task service needs that get ready before the current task",
      "items": {
        "type": "string"
      }
    },
    "mount": {
      "type": "array",
      "description": "A list of file paths that get mounted into the container",
      "items": {
        "type": "string"
      }
    },
    "taskPort": {
      "type": "array",
      "description": "A list of ports that get exposed on the host from the container <localPort>:<targetPort>",
      "items": {
        "description": "<localPort>:<targetPort>",
        "type": "string"
      }
    },
    "localTask": {
      "type": "object",
      "description": "A task that gets executed in the local shell",
      "additionalProperties": false,
      "properties": {
        "description": {
          "type": "string",
          "description": "A description of the task"
        },
        "extend": {
          "type": "string",
          "description": "Name of task that gets used a template"
        },
        "labels": {
          "$ref": "#/definitions/labels"
        },
        "envs": {
          "$ref": "#/definitions/envMap"
        },
        "needs": {
          "$ref": "#/definitions/taskNeed"
        },
        "deps": {
          "$ref": "#/definitions/taskDependency"
        },
        "cache": {
          "type": "string",
          "description": "compare type for detecting changes in source files",
          "enum": ["checksum", "modify-date", "none"]
        },
        "continuous": {
          "type": "boolean",
          "description": "The task runs continuous and does not end without cancellation"
        },
        "watch": {
          "type": "boolean",
          "description": "Watch the source files and restart the task on changes"
        },
        "src": {
          "$ref": "#/definitions/taskSource"
        },
        "generates": {
          "$ref": "#/definitions/taskGenerate"
        },
        "cmds": {
          "description": "A list of commands in a task",
          "type": "array",
          "items": {
            "$ref": "#/definitions/taskCommand"
          }
        }
      },
      "required": ["cmds"]
    },
    "dockerTask": {
      "required": ["cmds", "image"],
      "additionalProperties": false,
      "properties": {
        "description": {
          "type": "string",
          "description": "A description of the task"
        },
        "labels": {
          "$ref": "#/definitions/labels"
        },
        "extend": {
          "type": "string",
          "description": "Name of task that gets used a template"
        },
        "ports": {
          "$ref": "#/definitions/taskPort"
        },
        "envs": {
          "$ref": "#/definitions/envMap"
        },
        "needs": {
          "$ref": "#/definitions/taskNeed"
        },
        "deps": {
          "$ref": "#/definitions/taskDependency"
        },
        "cache": {
          "type": "string",
          "description": "compare type for detecting changes in source files",
          "enum": ["checksum", "modify-date", "none"]
        },
        "continuous": {
          "type": "boolean",
          "description": "The task runs continuous and does not end without cancellation"
        },
        "watch": {
          "type": "boolean",
          "description": "Watch the source files and restart the task on changes"
        },
        "shell": {
          "type": "string",
          "description": "Define which shell is used to execute the commands"
        },
        "image": {
          "type": "string",
          "description": "Define the container image the commands run in"
        },
        "mounts": {
          "$ref": "#/definitions/mount"
        },
        "src": {
          "$ref": "#/definitions/taskSource"
        },
        "generates": {
          "$ref": "#/definitions/taskGenerate"
        },
        "cmds": {
          "description": "A list of commands in a task",
          "type": "array",
          "items": {
            "$ref": "#/definitions/taskCommand"
          }
        }
      }
    },
    "task": {
      "anyOf": [{
        "$ref": "#/definitions/dockerTask"
      }, {
        "$ref": "#/definitions/localTask"
      }]
    },
    "service": {
      "description": "A daemon in the background",
      "anyOf": [{
        "$ref": "#/definitions/containerService"
      }, {
        "$ref": "#/definitions/kubernetesService"
      }]
    },
    "kubernetesService": {
      "required": ["context", "selector", "ports"],
      "additionalProperties": false,
      "properties": {
        "kubeconfig": {
          "type": "string",
          "description": ""
        },
        "context": {
          "type": "string",
          "description": ""
        },
        "ports": {
          "$ref": "#/definitions/taskPort"
        },
        "selector": {
          "required": ["type", "name"],
          "additionalProperties": false,
          "properties": {
            "type": {
              "type": "string",
              "enum": ["deployment", "service", "pod"]
            },
            "name": {
              "type": "string"
            }
          }
        }
      }
    },
    "containerService": {
      "required": ["image"],
      "additionalProperties": false,
      "properties": {
        "image": {
          "type": "string",
          "description": "Define the container image the commands run in"
        },
        "labels": {
          "$ref": "#/definitions/labels"
        },
        "envs": {
          "$ref": "#/definitions/envMap"
        },
        "ports": {
          "$ref": "#/definitions/taskPort"
        },
        "healthcheck": {
          "$ref": "#/definitions/serviceHealthcheck"
        },
        "volumes": {
          "$ref": "#/definitions/volume"
        },
        "mounts": {
          "$ref": "#/definitions/mount"
        }
      }
    },
    "serviceHealthcheck": {
      "additionalItems": false,
      "description": "A check to detect if the service is started and ready",
      "properties": {
        "cmd": {
          "description": "task to check if the service is healthy",
          "type": "string"
        }
      }
    }
  }
}
